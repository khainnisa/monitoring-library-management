# Docker image untuk CI/CD
image: php:8.2-cli

# Stages dalam pipeline
stages:
  - test
  - deploy

# Variables global
variables:
  MYSQL_ROOT_PASSWORD: rootpassword
  MYSQL_DATABASE: library_db
  MYSQL_USER: laravel
  MYSQL_PASSWORD: password
  DB_CONNECTION: mysql
  DB_HOST: mysql
  DB_PORT: 3306
  DB_DATABASE: library_db
  DB_USERNAME: laravel
  DB_PASSWORD: password

# Cache dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/

# Before script - install dependencies
before_script:
  - apt-get update -yqq
  - apt-get install -yqq git libzip-dev libpng-dev libonig-dev libxml2-dev unzip curl
  - docker-php-ext-install pdo_mysql mbstring zip exif pcntl bcmath gd
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  - composer install --no-interaction --prefer-dist --optimize-autoloader

# ===========================================
# STAGE 1: TESTING (CPMK2)
# ===========================================
test:unit:
  stage: test
  services:
    - name: mysql:8.0
      command: ["--default-authentication-plugin=mysql_native_password"]
  script:
    # Copy .env.example
    - cp .env.example .env

    # Override DB_HOST untuk GitLab CI (dari 'db' ke 'mysql')
    - sed -i "s/DB_HOST=db/DB_HOST=mysql/" .env

    # Generate key
    - php artisan key:generate
    - php artisan config:clear

    # Wait for MySQL to be ready
    - echo "‚è≥ Waiting for MySQL to be ready..."
    - |
      for i in {1..30}; do
        if php artisan migrate:status 2>/dev/null; then
          echo "‚úÖ MySQL is ready!"
          break
        fi
        echo "Waiting for MySQL... ($i/30)"
        sleep 2
      done

    # Run migrations
    - echo "üîÑ Running migrations..."
    - php artisan migrate:fresh --seed --force

    # Create directory dan run tests
    - mkdir -p storage/test-results
    - chmod -R 777 storage

    # Run tests
    - echo "üß™ Running tests..."
    - php artisan test --log-junit=storage/test-results/test-results.xml

  artifacts:
    when: always
    reports:
      junit: storage/test-results/test-results.xml
    paths:
      - storage/logs/
      - storage/test-results/
  only:
    - main
    - dev

test:coverage:
  stage: test
  services:
    - name: mysql:8.0
      command: ["--default-authentication-plugin=mysql_native_password"]
  script:
    # Copy .env.example
    - cp .env.example .env

    # Override DB_HOST untuk GitLab CI
    - sed -i "s/DB_HOST=db/DB_HOST=mysql/" .env

    # Generate key
    - php artisan key:generate
    - php artisan config:clear

    # Wait for MySQL
    - |
      for i in {1..30}; do
        if php artisan migrate:status 2>/dev/null; then
          echo "‚úÖ MySQL is ready!"
          break
        fi
        echo "Waiting for MySQL... ($i/30)"
        sleep 2
      done

    # Run migrations
    - php artisan migrate:fresh --seed --force

    # Install Xdebug
    - pecl install xdebug
    - docker-php-ext-enable xdebug
    - echo "xdebug.mode=coverage" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

    # Run tests with coverage
    - php artisan test --coverage-text

  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  only:
    - main
    - dev
  allow_failure: true

# ===========================================
# STAGE 2: DEPLOYMENT (CPMK3)
# ===========================================
deploy:staging:
  stage: deploy
  environment:
    name: staging
    url: https://staging.library-management.com
    on_stop: stop:staging
  script:
    - echo "========================================"
    - echo "üöÄ Deploying to STAGING environment"
    - echo "========================================"
    - echo "Application: $CI_PROJECT_NAME"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
    - echo "Database Host: $DB_HOST"
    - echo "Database Name: $DB_DATABASE"
    - echo "========================================"
    - echo "Running database migrations..."
    - echo "Caching configurations..."
    - echo "‚úÖ Staging deployment completed!"
    - echo "========================================"
  only:
    - dev
  when: manual

deploy:production:
  stage: deploy
  environment:
    name: production
    url: https://library-management.com
    on_stop: stop:production
  script:
    - echo "========================================"
    - echo "‚ö†Ô∏è  DEPLOYING TO PRODUCTION"
    - echo "========================================"
    - echo "Application: $CI_PROJECT_NAME"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
    - echo "========================================"
    - echo "Running database migrations..."
    - echo "Optimizing application..."
    - echo "Clearing caches..."
    - echo "‚úÖ Production deployment completed!"
    - echo "========================================"
  only:
    - main
  when: manual

# Stop environments
stop:staging:
  stage: deploy
  environment:
    name: staging
    action: stop
  script:
    - echo "Stopping staging environment..."
  when: manual
  only:
    - dev

stop:production:
  stage: deploy
  environment:
    name: production
    action: stop
  script:
    - echo "Stopping production environment..."
  when: manual
  only:
    - main
