stages:
  - test
  - deploy

variables:
  MYSQL_ROOT_PASSWORD: rootpassword
  MYSQL_DATABASE: library_db
  DB_CONNECTION: mysql
  DB_HOST: mysql
  DB_PORT: 3306
  DB_DATABASE: library_db
  DB_USERNAME: root
  DB_PASSWORD: rootpassword

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/

before_script:
  - apt-get update -yqq
  - apt-get install -yqq git libzip-dev libpng-dev libonig-dev libxml2-dev unzip curl default-mysql-client
  - docker-php-ext-install pdo_mysql mbstring zip exif pcntl bcmath gd
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  - composer install --no-interaction --prefer-dist --optimize-autoloader

test:unit:
  image: php:8.2-fpm
  stage: test
  services:
    - name: mysql:8.0
      alias: mysql
      command: ["--default-authentication-plugin=mysql_native_password", "--skip-ssl"]
  script:
    - echo "Waiting for MySQL to be ready..."
    - for i in {1..30}; do if mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "SELECT 1" &>/dev/null; then echo "MySQL is ready!"; break; fi; echo "Waiting for MySQL... ($i/30)"; sleep 2; done
    - echo "Setting up database..."
    - mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "CREATE DATABASE IF NOT EXISTS library_db;"
    - mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "SHOW DATABASES;"
    - echo "Setting up Laravel environment..."
    - rm -rf bootstrap/cache/*.php
    - rm -rf storage/framework/cache/data/*
    - rm -f .env
    - rm -f .env.example
    - echo "APP_NAME=LibraryManagement" > .env
    - echo "APP_ENV=testing" >> .env
    - echo "APP_KEY=" >> .env
    - echo "APP_DEBUG=true" >> .env
    - echo "APP_URL=http://localhost" >> .env
    - echo "" >> .env
    - echo "LOG_CHANNEL=stack" >> .env
    - echo "LOG_LEVEL=debug" >> .env
    - echo "" >> .env
    - echo "DB_CONNECTION=mysql" >> .env
    - echo "DB_HOST=mysql" >> .env
    - echo "DB_PORT=3306" >> .env
    - echo "DB_DATABASE=library_db" >> .env
    - echo "DB_USERNAME=root" >> .env
    - echo "DB_PASSWORD=rootpassword" >> .env
    - echo "" >> .env
    - echo "CACHE_DRIVER=array" >> .env
    - echo "QUEUE_CONNECTION=sync" >> .env
    - echo "SESSION_DRIVER=array" >> .env
    - echo "SESSION_LIFETIME=120" >> .env
    - echo "Current .env content:"
    - cat .env
    - echo "Clear all Laravel cache BEFORE loading .env..."
    - php artisan config:clear || true
    - php artisan cache:clear || true
    - php artisan route:clear || true
    - php artisan view:clear || true
    - rm -rf bootstrap/cache/config.php
    - rm -rf bootstrap/cache/packages.php
    - rm -rf bootstrap/cache/services.php
    - echo "Force reload environment variables..."
    - php -r "foreach (file('.env') as \$line) { if (trim(\$line) && strpos(\$line, '=') !== false && strpos(\$line, '#') !== 0) { putenv(trim(\$line)); } }"
    - echo "Verify .env database config:"
    - grep DB_ .env
    - echo ""
    - echo "Check if config/database.php has hardcoded values..."
    - grep -A 5 "'username'" config/database.php || echo "Cannot check database.php"
    - echo ""
    - echo "Override database config to force use ROOT..."
    - php -r "file_put_contents('config/database.php', str_replace(\"'username' => env('DB_USERNAME', 'forge')\", \"'username' => env('DB_USERNAME', 'root')\", file_get_contents('config/database.php')));"
    - php -r "file_put_contents('config/database.php', str_replace(\"'username' => 'laravel'\", \"'username' => env('DB_USERNAME', 'root')\", file_get_contents('config/database.php')));"
    - echo ""
    - echo "========================================="
    - echo "TESTING MySQL CONNECTION WITH ROOT USER"
    - echo "========================================="
    - echo "Connection details:"
    - echo "  Host: mysql"
    - echo "  User: root"
    - echo "  Database: library_db"
    - echo ""
    - echo "Executing MySQL query to verify user..."
    - mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "SELECT CONCAT('Current User: ', USER()) as info; SELECT CONCAT('Current Database: ', DATABASE()) as info; SELECT CONCAT('Connection ID: ', CONNECTION_ID()) as info;"
    - echo ""
    - echo "Checking user privileges..."
    - mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "SHOW GRANTS FOR 'root'@'%';" || mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "SHOW GRANTS;"
    - echo ""
    - echo "Listing all MySQL users..."
    - mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "SELECT User, Host FROM mysql.user;"
    - echo "========================================="
    - echo ""
    - echo "Generate Laravel APP_KEY..."
    - php artisan key:generate --force --ansi --no-interaction
    - echo "After key generate:"
    - cat .env | grep APP_KEY
    - echo ""
    - echo "FORCE config refresh to read .env..."
    - php artisan config:clear
    - php artisan config:cache
    - echo ""
    - echo "========================================="
    - echo "TESTING LARAVEL DATABASE CONNECTION"
    - echo "========================================="
    - echo "Laravel config database.connections.mysql:"
    - php artisan config:show database.connections.mysql || echo "Config check..."
    - echo ""
    - echo "Testing actual Laravel DB connection..."
    - php artisan db:monitor || php artisan db:show || echo "Attempting connection test..."
    - echo ""
    - echo "Verify connection with custom PHP script..."
    - php -r "require 'vendor/autoload.php'; \$app = require_once 'bootstrap/app.php'; \$kernel = \$app->make(Illuminate\Contracts\Console\Kernel::class); \$kernel->bootstrap(); echo '✓ Laravel DB Username: ' . config('database.connections.mysql.username') . PHP_EOL; echo '✓ Laravel DB Host: ' . config('database.connections.mysql.host') . PHP_EOL; echo '✓ Laravel DB Database: ' . config('database.connections.mysql.database') . PHP_EOL; try { \$pdo = DB::connection()->getPdo(); echo '✓ PDO Connection: SUCCESS' . PHP_EOL; echo '✓ Connected as: ' . DB::select(\"SELECT USER() as user\")[0]->user . PHP_EOL; } catch (Exception \$e) { echo '✗ Connection FAILED: ' . \$e->getMessage() . PHP_EOL; exit(1); }"
    - echo "========================================="
    - echo ""
    - echo "Running migrations..."
    - php artisan migrate:fresh --seed --force
    - echo "Setting up storage..."
    - mkdir -p storage/test-results
    - mkdir -p storage/logs
    - mkdir -p storage/framework/sessions
    - mkdir -p storage/framework/views
    - mkdir -p storage/framework/cache
    - chmod -R 777 storage
    - chmod -R 777 bootstrap/cache
    - echo "Running tests..."
    - vendor/bin/phpunit --log-junit=storage/test-results/test-results.xml || true
  artifacts:
    when: always
    reports:
      junit: storage/test-results/test-results.xml
    paths:
      - storage/logs/
      - storage/test-results/
    expire_in: 1 week
  only:
    - main
    - dev

test:coverage:
  image: php:8.2-fpm
  stage: test
  services:
    - name: mysql:8.0
      alias: mysql
      command: ["--default-authentication-plugin=mysql_native_password", "--skip-ssl"]
  script:
    - echo "Waiting for MySQL to be ready..."
    - for i in {1..30}; do if mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "SELECT 1" &>/dev/null; then echo "MySQL is ready!"; break; fi; echo "Waiting for MySQL... ($i/30)"; sleep 2; done
    - echo "Setting up database..."
    - mysql -hmysql -uroot -p$MYSQL_ROOT_PASSWORD --ssl=0 -e "CREATE DATABASE IF NOT EXISTS library_db;"
    - echo "Setting up Laravel environment..."
    - rm -rf bootstrap/cache/*.php
    - rm -rf storage/framework/cache/data/*
    - rm -f .env
    - rm -f .env.example
    - echo "APP_NAME=LibraryManagement" > .env
    - echo "APP_ENV=testing" >> .env
    - echo "APP_KEY=" >> .env
    - echo "APP_DEBUG=true" >> .env
    - echo "APP_URL=http://localhost" >> .env
    - echo "" >> .env
    - echo "LOG_CHANNEL=stack" >> .env
    - echo "LOG_LEVEL=debug" >> .env
    - echo "" >> .env
    - echo "DB_CONNECTION=mysql" >> .env
    - echo "DB_HOST=mysql" >> .env
    - echo "DB_PORT=3306" >> .env
    - echo "DB_DATABASE=library_db" >> .env
    - echo "DB_USERNAME=root" >> .env
    - echo "DB_PASSWORD=rootpassword" >> .env
    - echo "" >> .env
    - echo "CACHE_DRIVER=array" >> .env
    - echo "QUEUE_CONNECTION=sync" >> .env
    - echo "SESSION_DRIVER=array" >> .env
    - echo "SESSION_LIFETIME=120" >> .env
    - php artisan config:clear || true
    - php artisan cache:clear || true
    - rm -rf bootstrap/cache/config.php
    - php -r "foreach (file('.env') as \$line) { if (trim(\$line) && strpos(\$line, '=') !== false && strpos(\$line, '#') !== 0) { putenv(trim(\$line)); } }"
    - php -r "file_put_contents('config/database.php', str_replace(\"'username' => env('DB_USERNAME', 'forge')\", \"'username' => env('DB_USERNAME', 'root')\", file_get_contents('config/database.php')));"
    - php -r "file_put_contents('config/database.php', str_replace(\"'username' => 'laravel'\", \"'username' => env('DB_USERNAME', 'root')\", file_get_contents('config/database.php')));"
    - php artisan key:generate --force --ansi --no-interaction
    - php artisan config:clear
    - php artisan config:cache
    - echo "APP_KEY generated:"
    - cat .env | grep APP_KEY
    - php artisan migrate:fresh --seed --force
    - mkdir -p storage/framework/sessions
    - mkdir -p storage/framework/views
    - mkdir -p storage/framework/cache
    - chmod -R 777 storage
    - chmod -R 777 bootstrap/cache
    - echo "Installing Xdebug for coverage..."
    - pecl install xdebug
    - docker-php-ext-enable xdebug
    - echo "xdebug.mode=coverage" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    - echo "Running tests with coverage..."
    - vendor/bin/phpunit --coverage-text --coverage-cobertura=coverage.cobertura.xml
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.cobertura.xml
    paths:
      - coverage.cobertura.xml
    expire_in: 1 week
  only:
    - main
    - dev
  allow_failure: true

deploy:staging:
  image: alpine:latest
  stage: deploy
  environment:
    name: staging
    url: https://staging.library-management.com
    on_stop: stop:staging
  before_script:
    - apk add --no-cache openssh-client bash
  script:
    - echo "Deploying to STAGING environment"
    - echo "Application - $CI_PROJECT_NAME"
    - echo "Branch - $CI_COMMIT_REF_NAME"
    - echo "Commit - $CI_COMMIT_SHORT_SHA"
    - echo "Database - $DB_DATABASE"
    - echo "Staging deployment completed"
  only:
    - dev
  when: manual

deploy:production:
  image: alpine:latest
  stage: deploy
  environment:
    name: production
    url: https://library-management.com
    on_stop: stop:production
  before_script:
    - apk add --no-cache openssh-client bash
  script:
    - echo "Deploying to PRODUCTION environment"
    - echo "Application - $CI_PROJECT_NAME"
    - echo "Branch - $CI_COMMIT_REF_NAME"
    - echo "Commit - $CI_COMMIT_SHORT_SHA"
    - echo "Production deployment completed"
  only:
    - main
  when: manual

stop:staging:
  image: alpine:latest
  stage: deploy
  environment:
    name: staging
    action: stop
  script:
    - echo "Stopping staging environment"
  when: manual
  only:
    - dev

stop:production:
  image: alpine:latest
  stage: deploy
  environment:
    name: production
    action: stop
  script:
    - echo "Stopping production environment"
  when: manual
  only:
    - main